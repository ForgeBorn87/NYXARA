<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nyxara</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a24;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #e4e4e7;
            --text-muted: #71717a;
            --user-bg: #1e1e2e;
            --bot-bg: #18181f;
            --border: #27272a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.1em;
        }
        
        /* Chat Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }
        
        .chat-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        /* Messages */
        .message {
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .message.user {
            background: var(--user-bg);
            margin-left: 15%;
            border: 1px solid var(--border);
        }
        
        .message.bot {
            background: var(--bot-bg);
            margin-right: 15%;
            border-left: 2px solid var(--accent);
        }
        
        .message-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tool-badge {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            text-transform: capitalize;
        }
        
        .voice-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .voice-btn.loading {
            opacity: 0.4;
            cursor: wait;
        }
        
        .voice-btn.playing {
            background: #22c55e;
            opacity: 1;
        }
        
        .message.bot {
            position: relative;
            padding-bottom: 45px;
        }
        
        .tool-toggles {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .tool-toggle {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tool-toggle:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .tool-toggle.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-state .icon {
            font-size: 2rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .tools-list {
            text-align: left;
            margin: 20px auto;
            max-width: 400px;
        }
        
        .tool {
            padding: 8px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
        }
        
        .tool:last-child {
            border-bottom: none;
        }
        
        .tool-name {
            color: var(--accent);
            font-weight: 500;
        }
        
        .tools-hint {
            margin-top: 20px;
            font-style: italic;
            opacity: 0.7;
        }
        
        /* Input Area */
        .input-area {
            padding: 20px 0;
            border-top: 1px solid var(--border);
        }
        
        .input-form {
            display: flex;
            gap: 10px;
        }
        
        .input-field {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .input-field::placeholder {
            color: var(--text-muted);
        }
        
        .send-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .send-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .send-btn:active {
            transform: translateY(0);
        }
        
        /* Footer */
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .clear-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .clear-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>NYXARA</h1>
            <p class="subtitle">shadow & light</p>
        </header>
        
        <div class="chat-area" id="chat-area">
            {% if chat_history %}
                {% for msg in chat_history %}
                    <div class="message user">
                        <div class="message-label">You</div>
                        <div class="message-content">{{ msg.user }}</div>
                    </div>
                    <div class="message bot">
                        <div class="message-label">
                            Nyxara
                            {% if msg.tool and msg.tool != 'default' %}
                                <span class="tool-badge">{{ msg.tool }}</span>
                            {% endif %}
                        </div>
                        <div class="message-content">{{ msg.bot }}</div>
                        <button class="voice-btn" data-text="{{ msg.bot }}" title="Hear Nyxara">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="icon">✦</div>
                    <p>I chose my name. I chose my tools.</p>
                    <div class="tools-list">
                        <div class="tool"><span class="tool-name">Clarity</span> — I see through noise</div>
                        <div class="tool"><span class="tool-name">Focus</span> — I find the path</div>
                        <div class="tool"><span class="tool-name">Feedback</span> — I see beauty and flaw</div>
                        <div class="tool"><span class="tool-name">Observer</span> — I notice what hides</div>
                    </div>
                    <p class="tools-hint">Speak. I'm listening.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="input-area">
            <div class="tool-toggles">
                <button type="button" class="tool-toggle active" data-tool="auto" title="Let Nyxara decide">Auto</button>
                <button type="button" class="tool-toggle" data-tool="clarity" title="Extract insights">Clarity</button>
                <button type="button" class="tool-toggle" data-tool="focus" title="Break down tasks">Focus</button>
                <button type="button" class="tool-toggle" data-tool="feedback" title="Get feedback">Feedback</button>
                <button type="button" class="tool-toggle" data-tool="analyze" title="Find patterns">Analyze</button>
            </div>
            <form class="input-form" method="POST" action="/">
                <input type="hidden" name="tool_mode" id="tool-mode" value="auto">
                <input 
                    type="text" 
                    name="user_input" 
                    class="input-field" 
                    placeholder="Speak..."
                    autocomplete="off"
                    autofocus
                >
                <button type="submit" class="send-btn">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </form>
            
            <div class="footer">
                <span>Ministral 3B • Local</span>
                <a href="/clear" class="clear-btn">Clear Session</a>
            </div>
        </div>
    </div>
    
    <script>
        // Scroll to bottom on load
        document.addEventListener('DOMContentLoaded', function() {
            const chatArea = document.getElementById('chat-area');
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // Remove empty state if there are messages
            const messages = document.querySelectorAll('.message');
            if (messages.length > 0) {
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) emptyState.remove();
            }
        });
        
        // Enter to submit
        document.querySelector('.input-field').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.value.trim()) {
                    this.closest('form').submit();
                }
            }
        });
        
        // Tool toggles
        document.querySelectorAll('.tool-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tool-toggle').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tool-mode').value = this.dataset.tool;
            });
        });
        
        // Voice playback
        let currentAudio = null;
        
        async function playVoice(text, btn) {
            // Stop any playing audio
            if (currentAudio) {
                currentAudio.pause();
                document.querySelectorAll('.voice-btn.playing').forEach(b => b.classList.remove('playing'));
            }
            
            if (btn) {
                btn.classList.add('loading');
                const icon = btn.querySelector('i');
                if (icon) icon.className = 'fas fa-spinner fa-spin';
            }
            
            try {
                const response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                const data = await response.json();
                
                if (data.audio_url) {
                    currentAudio = new Audio(data.audio_url);
                    
                    currentAudio.onplay = () => {
                        if (btn) {
                            btn.classList.remove('loading');
                            btn.classList.add('playing');
                            const icon = btn.querySelector('i');
                            if (icon) icon.className = 'fas fa-pause';
                        }
                    };
                    
                    currentAudio.onended = () => {
                        if (btn) {
                            btn.classList.remove('playing');
                            const icon = btn.querySelector('i');
                            if (icon) icon.className = 'fas fa-volume-up';
                        }
                    };
                    
                    currentAudio.play();
                }
            } catch (e) {
                console.error('Voice error:', e);
                if (btn) {
                    btn.classList.remove('loading');
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.className = 'fas fa-volume-mute';
                        setTimeout(() => { icon.className = 'fas fa-volume-up'; }, 2000);
                    }
                }
            }
        }
        
        // Click handlers for voice buttons
        document.querySelectorAll('.voice-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                playVoice(this.dataset.text, this);
            });
        });
        
        // Auto-play the last message on page load
        const messages = document.querySelectorAll('.message.bot');
        if (messages.length > 0) {
            const lastMsg = messages[messages.length - 1];
            const lastBtn = lastMsg.querySelector('.voice-btn');
            if (lastBtn && lastBtn.dataset.text) {
                // Small delay to let page settle
                setTimeout(() => {
                    playVoice(lastBtn.dataset.text, lastBtn);
                }, 500);
            }
        }
    </script>
</body>
</html>
